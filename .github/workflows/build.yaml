on:
  workflow_dispatch:
    
jobs:
  build_systemd:
    strategy: 
      matrix:
        release_name: ['ubuntu_noble', 'ubuntu_jammy', 'debian_bookworm', 'debian_trixie', 'debian_unstable']
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        exclude:
          - release_name: debian_unstable
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: remove snap
        uses: ading2210/gh-actions-remove-snap@main

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y debootstrap binfmt-support pcregrep
    
      - name: Build
        run: | 
          distro="$(echo ${{ matrix.release_name }} | cut -d'_' -f1)"
          release="$(echo ${{ matrix.release_name }} | cut -d'_' -f2)"
          [ "$(uname -m)" = "x86_64" ] && arch="amd64" || arch="arm64"
          sudo DEBUG=1 ./build_systemd.sh $distro $release $arch
          target_release="$release"
          if [ "$target_release" = "trixie" ]; then
            target_release="osaka"
          fi
          mkdir -p out/${target_release}_${arch}
          cp build/*.deb out/${target_release}_${arch}
      
      - name: Upload artifact
        uses: actions/upload-artifact@master
        with:
          name: systemd_${{ matrix.release_name }}_${{ matrix.runner }}
          path: out
  
  build_mesa:
    strategy: 
      matrix:
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        branch: [debian-unstable, mesa-amber-21.3.9-1]

    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: remove snap
        uses: ading2210/gh-actions-remove-snap@main

      - name: Install deps
        run: | 
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y debootstrap binfmt-support

      - name: Build
        run: | 
          [ "$(uname -m)" = "x86_64" ] && arch="amd64" || arch="arm64"
          sudo ./build_mesa.sh debian bookworm $arch ${{ matrix.branch }}
          
          if [ "${{ matrix.branch }}" = "debian-unstable" ]; then
            mkdir -p out/unstable_$arch
            cp build/*.deb out/unstable_$arch
          else
            mkdir -p out/noble_$arch
            mkdir -p out/jammy_$arch
            mkdir -p out/bookworm_$arch
            mkdir -p out/osaka_$arch
            cp build/*.deb out/noble_$arch
            cp build/*.deb out/jammy_$arch
            cp build/*.deb out/bookworm_$arch
            cp build/*.deb out/osaka_$arch
          fi
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mesa_generic_${{ matrix.runner }}_${{ matrix.branch }}
          path: out
  
  publish:
      runs-on: ubuntu-24.04
      permissions:
        contents: read
        deployments: write
      needs: [build_systemd, build_mesa]

      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Install deps (dpkg-dev + gnupg + curl)
          run: |
            sudo apt-get update
            sudo apt-get install -y dpkg-dev gnupg curl

        - name: Setup dirs
          run: |
            mkdir -p repo download website

        - name: Download artifacts
          uses: actions/download-artifact@v4
          with:
            path: download
            merge-multiple: true

        # ðŸ” Persist GNUPGHOME across ALL next steps
        - name: Init persistent GNUPGHOME
          run: |
            echo "GNUPGHOME=$RUNNER_TEMP/.gnupg-fixcraft" >> "$GITHUB_ENV"
            mkdir -p "$RUNNER_TEMP/.gnupg-fixcraft"
            chmod 700 "$RUNNER_TEMP/.gnupg-fixcraft"

        # ðŸ” Import APT signing key (into persistent GNUPGHOME)
        - name: Import APT signing key
          env:
            APT_GPG_KEY_ASC: ${{ secrets.APT_GPG_KEY_ASC }}
          run: |
            set -euo pipefail
            echo "$APT_GPG_KEY_ASC" | base64 -d > key.asc
            gpg --batch --yes --pinentry-mode loopback --import key.asc
            rm -f key.asc
            echo "[i] Secret keys:"
            gpg --list-secret-keys

        # ðŸ§¾ (Optional) derive KEYID from imported key if you don't trust the secret
        - name: Derive APT_GPG_KEY_ID if missing
          id: gpg
          shell: bash
          run: |
            set -euo pipefail
            KEYID_INPUT="${{ secrets.APT_GPG_KEY_ID }}"
            if [ -n "$KEYID_INPUT" ]; then
              echo "keyid=$KEYID_INPUT" >> "$GITHUB_OUTPUT"
            else
              KEYID="$(gpg --list-secret-keys --with-colons | awk -F: '/^fpr:/{print $10; exit}')"
              echo "keyid=$KEYID" >> "$GITHUB_OUTPUT"
            fi
            echo "[i] Using KEYID: $(cat $GITHUB_OUTPUT | sed -n 's/keyid=//p')"

        # ðŸ—ï¸ Build repo (SIGNED) â€” uses the SAME GNUPGHOME
        - name: Build repo (signed)
          env:
            APT_GPG_KEY_ID: ${{ steps.gpg.outputs.keyid }}
            APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
          run: |
            set -euo pipefail
            DEBUG=1 ./build_repo.sh
            mv repo/ website/iridium/

        # ðŸ“¤ Export public key files to the website
        - name: Publish public key files
          env:
            APT_GPG_KEY_ID: ${{ steps.gpg.outputs.keyid }}   # or use your secrets var
          run: |
            set -euo pipefail
            mkdir -p website/iridium
            gpg --list-secret-keys "$APT_GPG_KEY_ID" >/dev/null
            # ASCII armored (for humans / curl)
            gpg --armor --export "$APT_GPG_KEY_ID" > website/iridium/iridium-archive-keyring.gpg.asc
            # Dearmored (for apt signed-by=)
            gpg --export "$APT_GPG_KEY_ID" > website/iridium/iridium-archive-keyring.gpg
            # Optional: print fingerprint into a text for quick eyes
            gpg --with-colons --fingerprint "$APT_GPG_KEY_ID" \
              | awk -F: '/^fpr:/{print $10; exit}' > website/iridium/iridium-archive-keyring.fpr

        # âœ… Sanity: ensure InRelease exists BEFORE deploy
        - name: Sanity check signed metadata
          run: |
            set -euo pipefail
            test -s website/iridium/dists/osaka/InRelease
            echo "[OK] InRelease present"
            # optional: peek first lines
            head -n 12 website/iridium/dists/osaka/Release

        - name: Generate indexes
          run: ./generate_index.sh

        - name: Deploy to Cloudflare Pages
          uses: cloudflare/pages-action@v1
          with:
            apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            accountId: 1d7388828485ee362baf5701357a60d3
            projectName: fixcraft
            directory: website
