on:
  workflow_dispatch:
    
jobs:
  build_systemd:
    strategy: 
      matrix:
        release_name: ['ubuntu_noble', 'ubuntu_jammy', 'debian_bookworm', 'debian_trixie', 'debian_unstable']
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        exclude:
          - release_name: debian_unstable
            runner: ubuntu-24.04-arm

    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: remove snap
        uses: ading2210/gh-actions-remove-snap@main

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y debootstrap binfmt-support pcregrep
    
      - name: Build
        run: | 
          distro="$(echo ${{ matrix.release_name }} | cut -d'_' -f1)"
          release="$(echo ${{ matrix.release_name }} | cut -d'_' -f2)"
          [ "$(uname -m)" = "x86_64" ] && arch="amd64" || arch="arm64"
          sudo DEBUG=1 ./build_systemd.sh $distro $release $arch
          target_release="$release"
          if [ "$target_release" = "trixie" ]; then
            target_release="osaka"
          fi
          mkdir -p out/${target_release}_${arch}
          cp build/*.deb out/${target_release}_${arch}
      
      - name: Upload artifact
        uses: actions/upload-artifact@master
        with:
          name: systemd_${{ matrix.release_name }}_${{ matrix.runner }}
          path: out
  
  build_mesa:
    strategy: 
      matrix:
        runner: [ubuntu-24.04, ubuntu-24.04-arm]
        branch: [debian-unstable, mesa-amber-21.3.9-1]

    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: remove snap
        uses: ading2210/gh-actions-remove-snap@main

      - name: Install deps
        run: | 
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get install -y debootstrap binfmt-support

      - name: Build
        run: | 
          [ "$(uname -m)" = "x86_64" ] && arch="amd64" || arch="arm64"
          sudo ./build_mesa.sh debian bookworm $arch ${{ matrix.branch }}
          
          if [ "${{ matrix.branch }}" = "debian-unstable" ]; then
            mkdir -p out/unstable_$arch
            cp build/*.deb out/unstable_$arch
          else
            mkdir -p out/noble_$arch
            mkdir -p out/jammy_$arch
            mkdir -p out/bookworm_$arch
            mkdir -p out/osaka_$arch
            cp build/*.deb out/noble_$arch
            cp build/*.deb out/jammy_$arch
            cp build/*.deb out/bookworm_$arch
            cp build/*.deb out/osaka_$arch
          fi
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mesa_generic_${{ matrix.runner }}_${{ matrix.branch }}
          path: out
  
  publish:
      runs-on: ubuntu-24.04
      permissions:
        contents: read
        deployments: write
      needs: [build_systemd, build_mesa]
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Install deps (dpkg-dev + gnupg)
          run: |
            sudo apt-get update
            sudo apt-get install -y dpkg-dev gnupg

        - name: Setup dirs
          run: |
            mkdir -p repo download

        - name: Download artifacts
          uses: actions/download-artifact@v4
          with:
            path: download
            merge-multiple: true

        # ðŸ” Import signing key to ephemeral GNUPGHOME
        - name: Import APT signing key
          env:
            APT_GPG_KEY_ASC: ${{ secrets.APT_GPG_KEY_ASC }}
          run: |
            set -euo pipefail
            export GNUPGHOME="$(mktemp -d)"
            echo "$APT_GPG_KEY_ASC" | base64 -d > key.asc
            gpg --batch --yes --pinentry-mode loopback --import key.asc
            rm -f key.asc
            gpg --list-secret-keys

        # ðŸ—ï¸ Build repo (your script signs when KEY_ID + PASSPHRASE are set)
        - name: Build repo (signed)
          env:
            APT_GPG_KEY_ID: ${{ secrets.APT_GPG_KEY_ID }}
            APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
          run: |
            set -euo pipefail
            DEBUG=1 ./build_repo.sh
            mkdir -p website
            mv repo/ website/iridium/

        # ðŸ“¤ Export public key to site (ASCII + dearmored)
        - name: Publish public key files
          env:
            APT_GPG_KEY_ID: ${{ secrets.APT_GPG_KEY_ID }}
          run: |
            set -euo pipefail
            # ASCII armored (nice for humans)
            gpg --armor --export "$APT_GPG_KEY_ID" > website/iridium/iridium-archive-keyring.gpg.asc
            # Dearmored (nice for signed-by= path)
            gpg --export "$APT_GPG_KEY_ID" > website/iridium/iridium-archive-keyring.gpg

        # ðŸ§­ Generate directory indexes
        - name: Generate indexes
          run: |
            ./generate_index.sh

        # ðŸ”Ž (Optional) quick smoke test to print HTTP codes before deploy
        - name: Smoke check
          run: |
            set -euo pipefail
            for A in amd64 arm64; do
              for D in osaka bookworm jammy noble unstable; do
                echo "== $D/$A =="
                curl -fsS -o /dev/null -w "InRelease:%{http_code}\n" "https://fixcraft.pages.dev/iridium/dists/$D/InRelease" || true
                curl -fsS -o /dev/null -w "Packages.gz:%{http_code}\n" "https://fixcraft.pages.dev/iridium/dists/$D/main/binary-$A/Packages.gz" || true
              done
            done

        - name: Deploy to Cloudflare Pages
          uses: cloudflare/pages-action@v1
          with:
            apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
            accountId: 1d7388828485ee362baf5701357a60d3
            projectName: fixcraft
            directory: website
